# Makefile for Data Acquisition Daemon

SHELL = /bin/sh

top_srcdir=@top_srcdir@
srcdir=@srcdir@
VPATH=@srcdir@

prefix      = @prefix@
exec_prefix = @exec_prefix@
bindir      = @bindir@
infodir     = @infodir@
mandir      = @mandir@
infodir     = @infodir@
libdir      = @libdir@
datarootdir      = @datarootdir@


CXX=@CXX@
CC=@CC@
LIBS=@LIBS@
DEBUGFLAGS=-g -Wno-deprecated -Wno-write-strings
PERFORMANCEFLAGS=-DNDEBUG -g -O
RELEASEFLAGS=-DNDEBUG -DNPROBE -g -O
#DEBUGFLAGS=-DNDEBUG -O5 -unroll=16
DEVFLAGS=@DEVFLAGS@

BUILD_MODE_FLAGS=@BUILD_MODE_FLAGS@

EPICSFLAGS=@EPICSFLAGS@
EPICSLIBFLAGS=@EPICSLIBFLAGS@

GDS_ARCHIVE=@srcdir@/../gds
GDS_INCLUDES=-I$(GDS_ARCHIVE)
#GDS_INCLUDES=-I$(GDS_ARCHIVE)/src/util -I$(GDS_ARCHIVE)/src/err -I$(GDS_ARCHIVE)/src/sched -I$(GDS_ARCHIVE)/src/gpstime -I$(GDS_ARCHIVE)/src/drv -I$(GDS_ARCHIVE)/src/daq -I$(GDS_ARCHIVE)/src/rmem 
GDS_DEFINES=-DLIGO_GDS -D_TP_DAQD -DARCHIVE=\"$(GDS_ARCHIVE)\" $(GDS_INCLUDES)
CDS_GDSFLAGS=-DGDS_TESTPOINT_SUPPORT
CDS_GDSLIBFLAGS=-L$(GDS_ARCHIVE)/lib -L$(GDS_ARCHIVE)/lib64 
CDS_GDSOBJECTS=gds.o testpoint.o gdsstring.o gdserr.o rtestpoint_clnt.o rtestpoint_xdr.o gdsheartbeat.o rpcinc.o gdssched.o tconv.o gdstask.o gdsxdr_util.o sockutil.o
GDSFLAGS=@GDSFLAGS@
GDSLIBFLAGS=@GDSLIBFLAGS@
GDSOBJECTS=@GDSOBJECTS@
RUN_NUMBER_ARCHIVE=@srcdir@/../run_number
RUN_NUMBER_OBJECTS=run_number_client.o
RUN_NUMBER_LIBS=-lzmq

BROADCAST_OBJECTS=framesend.o gdsmutex.o
BROADCASTOBJECTS=@BROADCASTOBJECTS@

LDASFLAGS=@LDASFLAGS@
LDASLIBFLAGS=@LDASLIBFLAGS@ -lz -lbz2

VARIOUS_DEFINES=-DSERVER_VERSION=\"2.0\" "-DPRODUCTION_DATE=\"`date`\"" "-DPRODUCTION_MACHINE=\"`uname -a`\"" ${GDSFLAGS} ${LDASFLAGS} ${EPICSFLAGS} ${MYRINET_FLAGS} ${MX_FLAGS}
INCLUDEFLAGS=-I. -I@srcdir@ -I$(srcdir)/../include -I$(srcdir)/../run_number
CFLAGS=${VARIOUS_DEFINES} ${DEVFLAGS} ${BUILD_MODE_FLAGS} -c ${INCLUDEFLAGS} -D_REENTRANT  -DNO_RTL=1
CCFLAGS=${CFLAGS} @CPPFLAGS@ -g -O
LEX=flex -+
YACC=@YACC@ -o y.tab.c
YFLAGS=-d

SRCS= archive.cc profiler.cc gds.cc filesys.cc epics_pvs.cc @PRODUCER_CC@ trend.cc  net_writer.cc daqd.cc circ.cc comm.y comm-lex.l framesend.cc gdsmutex.cc edcu.cc @EPICS_SRCS@ @MYRINET_SRCS@ @MX_SRCS@ framerecv.cc listener.cc

EPICS_SRCS=epicsServer.cc exServer.cc exPV.cc exScalarPV.cc exVectorPV.cc exChannel.cc
EPICS_OBJS=epicsServer.o exServer.o exPV.o exScalarPV.o exVectorPV.o exChannel.o
MYRINET_SRCS=gm_rcvr.cc
MYRINET_OBJS=gm_rcvr.o
MYRINET_FLAGS=-I/opt/gm/include
MYRINET_LDFLAGS=-L/opt/gm/lib -L/opt/gm/lib64 -lgm

MX_SRCS=mx_rcvr.cc
MX_OBJS=mx_rcvr.o
MX_FLAGS=-I/home2/jonathan.hanks/installed/open-mx/include
MX_LDFLAGS=-L/home2/jonathan.hanks/installed/open-mx/lib -lmyriexpress
OMX_FLAGS=-I/opt/open-mx/include
OMX_LDFLAGS=-L/opt/open-mx/lib -lopen-mx

all: 
	make -j `grep processor /proc/cpuinfo  | wc -l` daqd-all

daqd-all: daqd


daqd.o: comm.o

daqd: daqd.out
	/bin/mv daqd.out daqd

daniel_stream:	daniel_stream.o framesend.o gdstask.o gdsmutex.o
	$(CXX) $(DEBUGFLAGS)  -o daniel_stream daniel_stream.o framesend.o gdstask.o gdsmutex.o $(LIBS) -lpthread

crc8: crc8.cc
	$(CXX) -DUSE_MAIN=1 $< -o crc8

mx_rcvr1.o: mx_rcvr.cc
	$(CXX) $(CCFLAGS) -DUSE_MAIN=1 $< -o mx_rcvr1.o

mxrecv: mx_rcvr1.o
	$(CXX) $(DEBUGFLAGS) -o mxrecv mx_rcvr1.o  $(LIBS) $(MX_LDFLAGS) $(LDASLIBFLAGS)

framerecv1.o: framerecv.cc
	$(CXX) $(CCFLAGS) -DUSE_MAIN=1 $< -o framerecv1.o

rcv: framerecv1.o
	$(CXX) $(DEBUGFLAGS) -o rcv framerecv1.o $(LIBS)

rfmreader: rfmreader.o
	$(CXX) $(DEBUGFLAGS) -o rfmreader rfmreader.o -lrt

cpstriped: cpstriped.o
	$(CC) $(DEBUGFLAGS) -o cpstriped cpstriped.o 

cts2l: cts2l.c
	$(CC) -m32 $(DEBUGFLAGS) -o cts2l $(srcdir)/cts2l.c 

clean:
	-/bin/rm  *.o comm.cc comm-lex.cc y.tab.h

realclean: clean
	-/bin/rm daqd *.out core config.status config.cache

.cc.o:
	$(CXX) $(CCFLAGS) $<

gds.o: gds.cc
	$(CXX) $(CCFLAGS) $(GDS_DEFINES) $<



testpoint.o:	${GDS_ARCHIVE}/testpoint.c
	$(CC) -c -D_TP_DAQD -D_TESTPOINT_DIRECT=0 -D_NO_KEEP_ALIVE $<

gdsstring.o:    ${GDS_ARCHIVE}/gdsstring.c
	$(CC) -c -D_TP_DAQD -D_TESTPOINT_DIRECT=0 $<

gdserr.o:    ${GDS_ARCHIVE}/gdserr.c
	$(CC) -c -D_TP_DAQD -D_TESTPOINT_DIRECT=0 $<

rtestpoint_clnt.o: ${GDS_ARCHIVE}/rtestpoint_clnt.c
	$(CC) -c -D_TP_DAQD -D_TESTPOINT_DIRECT=0 $<

rtestpoint_xdr.o: ${GDS_ARCHIVE}/rtestpoint_xdr.c
	$(CC) -c -D_TP_DAQD -D_TESTPOINT_DIRECT=0 $<

rmapi.o:	${GDS_ARCHIVE}/rmapi.c
	$(CC) -c -D_TP_DAQD -D_TESTPOINT_DIRECT=0 $<

gdsheartbeat.o:	${GDS_ARCHIVE}/gdsheartbeat.c
	$(CC) -c -D_TP_DAQD -D_TESTPOINT_DIRECT=0 $<

rpcinc.o:	${GDS_ARCHIVE}/rpcinc.c
	$(CC) -c -D_TP_DAQD -D_TESTPOINT_DIRECT=0 $<

gdssched.o:	${GDS_ARCHIVE}/gdssched.c
	$(CC) -c -D_TP_DAQD -D_TESTPOINT_DIRECT=0 $<

tconv.o:	${GDS_ARCHIVE}/tconv.c
	$(CC) -c -D_TP_DAQD -D_TESTPOINT_DIRECT=0 $<

gdstask.o:	${GDS_ARCHIVE}/gdstask.c
	$(CC) -c -D_TP_DAQD -D_TESTPOINT_DIRECT=0 $<

gdsxdr_util.o:	${GDS_ARCHIVE}/gdsxdr_util.c
	$(CC) -c -D_TP_DAQD -D_TESTPOINT_DIRECT=0 $<

sockutil.o:	${GDS_ARCHIVE}/sockutil.c
	$(CC) -c -D_TP_DAQD -D_TESTPOINT_DIRECT=0 $<

run_number_client.o: ${RUN_NUMBER_ARCHIVE}/run_number_client.cc
	$(CXX) -c ${CXXFLAGS} -I$(srcdir)/@ZMQ_INCLUDES@ $<


# -DNDEBUG is killing Channel Access server code (Epics R3.14.4)
# Need to build without -DNDEBUG
exScalarPV.o: exScalarPV.cc
	$(CXX) -c ${CCFLAGS} ${EPICSFLAGS}  -D_REENTRANT $<
exVectorPV.o: exVectorPV.cc
	$(CXX) -c ${CCFLAGS} ${EPICSFLAGS}  -D_REENTRANT $<

daqd.out: archive.o $(RUN_NUMBER_OBJECTS) $(GDSOBJECTS) profiler.o filesys.o epics_pvs.o @PRODUCER_O@ trend.o net_writer.o comm.o daqd.o circ.o $(BROADCASTOBJECTS) edcu.o @EPICS_OBJS@ @MYRINET_OBJS@ @MX_OBJS@ framerecv.o comm-lex.o listener.o
	$(CXX) $(DEBUGFLAGS) -o daqd.out archive.o $(RUN_NUMBER_OBJECTS) $(GDSOBJECTS) profiler.o filesys.o epics_pvs.o @PRODUCER_O@ trend.o net_writer.o daqd.o circ.o ./comm.o  $(BROADCASTOBJECTS) edcu.o framerecv.o comm-lex.o listener.o  @EPICS_OBJS@ @MYRINET_OBJS@ @MX_OBJS@ $(SCRAMLIBFLAGS) $(GDSLIBFLAGS) $(EPICSLIBFLAGS) $(LDASLIBFLAGS) @MYRINET_LDFLAGS@ @MX_LDFLAGS@ -lpthread $(LIBS) $(RUN_NUMBER_LIBS) @LDFLAGS@

daqcn: daqcn.o daqc_access.o
	$(CC) $(DEBUGFLAGS) -o daqcn daqcn.o daqc_access.o -lpthread $(LIBS)

md5sum: md5sum.o md5.o
	$(CC) $(DEBUGFLAGS) -o md5sum md5sum.o md5.o

comm-lex.o: comm-lex.l
	$(RM) comm-lex.cc
	$(LEX.l) $(srcdir)/comm-lex.l > comm-lex.cc
	$(CXX) $(CCFLAGS) comm-lex.cc

#comm-lex.cc: y.tab.h
#listener.cc: y.tab.h

y.tab.h comm.o: comm.y
	$(YACC) $(YFLAGS) $(srcdir)/comm.y
	/bin/mv -f y.tab.c comm.cc
	$(CC) $(CCFLAGS) -O comm.cc

#daqd.o: y.tab.h
#listener.o: y.tab.h

circ-scope.o: circ.cc
	$(CXX) $(CCFLAGS) -o circ-scope.o $<

#---

depend:
	objdir=`pwd`; cd $(srcdir); makedepend -f $$objdir/Makefile  -- -I$$objdir  $(CFLAGS)  -I/usr/local/lib/g++-include -- $(SRCS) daqcn.c daqc_access.c


# DO NOT DELETE THIS LINE -- make depend depends on it.
