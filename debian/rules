#!/usr/bin/make -f

SVERSION := $(shell dpkg-parsechangelog --show-field=Version | rev | cut -d- -f2- | rev)

%:
	dh $@ --builddirectory=build --with dkms


install-mbuf:
	dh_installdirs -padvligorts-mbuf-dkms usr/src/mbuf-$(SVERSION)
	install --mode=644 -t debian/advligorts-mbuf-dkms/usr/src/mbuf-$(SVERSION) src/drv/mbuf/*

install-symmetricom:
	install -d debian/advligorts-symmetricom-dkms/usr/src/symmetricom-$(SVERSION)/drv/symmetricom
	install --mode=644 -t debian/advligorts-symmetricom-dkms/usr/src/symmetricom-$(SVERSION)/drv/symmetricom src/drv/symmetricom/*
	install -d debian/advligorts-symmetricom-dkms/usr/src/symmetricom-$(SVERSION)/include/drv
	install --mode=644 -t debian/advligorts-symmetricom-dkms/usr/src/symmetricom-$(SVERSION)/include/drv src/include/drv/*
	install --mode=644 -t debian/advligorts-symmetricom-dkms/usr/src/symmetricom-$(SVERSION)/include/ src/include/proc.h

install-support:
	sed 's|__PREFIX__|/usr|' <setup/udev/mbuf.rules >debian/advligorts-module-support/lib/udev/rules.d/60-mbuf.rules
	sed 's|__PREFIX__|/usr|' <setup/udev/symmetricom.rules >debian/advligorts-module-support/lib/udev/rules.d/60-symmetricom.rules


override_dh_auto_configure:
	mkdir -p build
	(cd build && cmake -DCMAKE_INSTALL_PREFIX=$(DESTDIR)/usr ..)

override_dh_auto_build:
	true

override_dh_make:
	true

override_dh_install: install-symmetricom install-mbuf install-support
	dh_install

override_dh_dkms:
	dh_dkms -V $(SVERSION)

override_dh_auto_test:
	true

# override_dh_clean:
# 	rm -rf build
